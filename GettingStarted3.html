<html>
<head>
<meta charset="utf-8">
<title>Nylas Mail — GettingStarted3.md</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<link rel="stylesheet" type="text/css" href="css/main.css"/>
<link rel="stylesheet" type="text/css" href="css/tomorrow.css">
</head>
<body>
<div id="header">
  <div class="container">
    <img src="images/edgehill.png" class="logo" />
    <div class="title">Nylas Mail<div class="small">Developer Preview</div></div>
  </div>
</div>

<div class="container">

<div class="page-title">GettingStarted3.md</div>

<div id="sidebar">
  <div class="heading">Getting Started</div>
  <ul>
        <li><a href="Index.html" >Welcome</a></li>
  </ul>
  <div class="heading">Guides</div>
  <ul>
        <li><a href="PackageOverview.html" >Building a Package</a></li>
        <li><a href="InterfaceConcepts.html" >Interface Concepts</a></li>
        <li><a href="React.html" >Interface Components</a></li>
        <li><a href="Architecture.html" >Application Architecture</a></li>
        <li><a href="Debugging.html" >Debugging N1</a></li>
        <li><a href="Database.html" >Accessing the Database</a></li>
        <li><a href="DraftStoreExtensions.html" >Extending the Composer</a></li>
        <li><a href="WritingSpecs.html" >Writing Specs</a></li>
        <li><a href="FAQ.html" >FAQ</a></li>
  </ul>
  <div class="heading">Sample Code</div>
  <ul>
        <li><a href="https://github.com/nylas/edgehill-plugins/tree/master/translate" target="_blank">Composer Translation</a></li>
        <li><a href="https://github.com/nylas/edgehill-plugins/tree/master/sidebar-github-profile" target="_blank">Github Sidebar</a></li>
  </ul>
  <div class="heading">API Reference</div>
  <ul>
        <div class="heading">General</div>
        <ul>
              <li><a href="Actions.html" >Actions</a></li>
              <li><a href="Atom.html" >Atom</a></li>
              <li><a href="BufferedNodeProcess.html" >BufferedNodeProcess</a></li>
              <li><a href="BufferedProcess.html" >BufferedProcess</a></li>
              <li><a href="ChangeFolderTask.html" >ChangeFolderTask</a></li>
              <li><a href="ChangeLabelsTask.html" >ChangeLabelsTask</a></li>
              <li><a href="Config.html" >Config</a></li>
              <li><a href="DraggableImg.html" >DraggableImg</a></li>
              <li><a href="FocusTrackingRegion.html" >FocusTrackingRegion</a></li>
              <li><a href="Task.html" >Task</a></li>
              <li><a href="TaskQueueStatusStore.html" >TaskQueueStatusStore</a></li>
        </ul>
        <div class="heading">Component Kit</div>
        <ul>
              <li><a href="EventedIFrame.html" >EventedIFrame</a></li>
              <li><a href="Flexbox.html" >Flexbox</a></li>
              <li><a href="InjectedComponent.html" >InjectedComponent</a></li>
              <li><a href="InjectedComponentSet.html" >InjectedComponentSet</a></li>
              <li><a href="Menu.html" >Menu</a></li>
              <li><a href="MenuItem.html" >MenuItem</a></li>
              <li><a href="MenuNameEmailItem.html" >MenuNameEmailItem</a></li>
              <li><a href="MultiselectActionBar.html" >MultiselectActionBar</a></li>
              <li><a href="MultiselectList.html" >MultiselectList</a></li>
              <li><a href="Popover.html" >Popover</a></li>
              <li><a href="ResizableRegion.html" >ResizableRegion</a></li>
              <li><a href="RetinaImg.html" >RetinaImg</a></li>
              <li><a href="Spinner.html" >Spinner</a></li>
              <li><a href="TimeoutTransitionGroupChild.html" >TimeoutTransitionGroupChild</a></li>
              <li><a href="UnsafeComponent.html" >UnsafeComponent</a></li>
        </ul>
        <div class="heading">Models</div>
        <ul>
              <li><a href="Account.html" >Account</a></li>
              <li><a href="Calendar.html" >Calendar</a></li>
              <li><a href="Contact.html" >Contact</a></li>
              <li><a href="File.html" >File</a></li>
              <li><a href="Folder.html" >Folder</a></li>
              <li><a href="Label.html" >Label</a></li>
              <li><a href="Message.html" >Message</a></li>
              <li><a href="Model.html" >Model</a></li>
              <li><a href="Thread.html" >Thread</a></li>
        </ul>
        <div class="heading">Stores</div>
        <ul>
              <li><a href="AccountStore.html" >AccountStore</a></li>
              <li><a href="ComponentRegistry.html" >ComponentRegistry</a></li>
              <li><a href="ContactStore.html" >ContactStore</a></li>
              <li><a href="EventStore.html" >EventStore</a></li>
              <li><a href="FocusedContentStore.html" >FocusedContentStore</a></li>
              <li><a href="MessageStoreExtension.html" >MessageStoreExtension</a></li>
              <li><a href="TaskQueue.html" >TaskQueue</a></li>
              <li><a href="WorkspaceStore.html" >WorkspaceStore</a></li>
        </ul>
        <div class="heading">Database</div>
        <ul>
              <li><a href="Attribute.html" >Attribute</a></li>
              <li><a href="AttributeBoolean.html" >AttributeBoolean</a></li>
              <li><a href="AttributeCollection.html" >AttributeCollection</a></li>
              <li><a href="AttributeDateTime.html" >AttributeDateTime</a></li>
              <li><a href="AttributeJoinedData.html" >AttributeJoinedData</a></li>
              <li><a href="AttributeNumber.html" >AttributeNumber</a></li>
              <li><a href="AttributeObject.html" >AttributeObject</a></li>
              <li><a href="AttributeServerId.html" >AttributeServerId</a></li>
              <li><a href="AttributeString.html" >AttributeString</a></li>
              <li><a href="DatabaseStore.html" >DatabaseStore</a></li>
              <li><a href="DatabaseView.html" >DatabaseView</a></li>
              <li><a href="Matcher.html" >Matcher</a></li>
              <li><a href="ModelQuery.html" >ModelQuery</a></li>
              <li><a href="SortOrder.html" >SortOrder</a></li>
        </ul>
        <div class="heading">Drafts</div>
        <ul>
              <li><a href="DraftChangeSet.html" >DraftChangeSet</a></li>
              <li><a href="DraftStore.html" >DraftStore</a></li>
              <li><a href="DraftStoreExtension.html" >DraftStoreExtension</a></li>
              <li><a href="DraftStoreProxy.html" >DraftStoreProxy</a></li>
        </ul>
        <div class="heading">Atom</div>
        <ul>
              <li><a href="Clipboard.html" >Clipboard</a></li>
              <li><a href="Color.html" >Color</a></li>
              <li><a href="CommandRegistry.html" >CommandRegistry</a></li>
              <li><a href="DeserializerManager.html" >DeserializerManager</a></li>
              <li><a href="MenuManager.html" >MenuManager</a></li>
              <li><a href="PackageManager.html" >PackageManager</a></li>
              <li><a href="ScopeDescriptor.html" >ScopeDescriptor</a></li>
              <li><a href="StyleManager.html" >StyleManager</a></li>
              <li><a href="ThemeManager.html" >ThemeManager</a></li>
        </ul>
  </ul>
</div>
<div id="main" class="article">
<h2 class="gsg-header">Step 3: Adding a Data Store</h2>

<p>Building on the <a href="getting-started-2">previous part</a> of our Getting Started guide, we&#39;re going to introduce a data store to give our sidebar superpowers.</p>
<h2 id="stores-and-data-flow">Stores and Data Flow</h2>
<p>The Nylas data model revolves around a central <code>DatabaseStore</code> and lightweight <code>Models</code> that represent data with a particular schema. This works a lot like ActiveRecord, SQLAlchemy and other &quot;smart model&quot; ORMs. See the <a href="database">Database</a> explanation for more details.</p>
<p>Using the <a href="https://facebook.github.io/flux/docs/overview.html#structure-and-data-flow">Flux pattern</a> for data flow means that we set up our UI components to &#39;listen&#39; to specific data stores. When those stores change, we update the state inside our component, and re-render the view.</p>
<p>We&#39;ve already used this (without realizing) in the <a href="getting-started-2">Gravatar sidebar example</a>:</p>
<pre><code class="lang-coffee">  componentDidMount: =&gt;
    @unsubscribe = FocusedContactsStore.<span class="hljs-function"><span class="hljs-title">listen</span><span class="hljs-params">(@_onChange)</span></span>
  ...
  _onChange: =&gt;
    @<span class="hljs-function"><span class="hljs-title">setState</span><span class="hljs-params">(@_getStateFromStores()</span></span>)

  _getStateFromStores: =&gt;
    contact: FocusedContactsStore.<span class="hljs-function"><span class="hljs-title">focusedContact</span><span class="hljs-params">()</span></span>
</code></pre>
<p>In this case, the sidebar listens to the <code>FocusedContactsStore</code>, which updates when the person selected in the conversation changes. This triggers the <code>_onChange</code> method which updates the component state; this causes React to render the view with the new state.</p>
<p>To add more depth to our sidebar package, we need to:</p>
<ul>
<li>Create our own data store which will listen to <code>FocusedContactsStore</code></li>
<li>Extend our data store to do additional things with the contact data</li>
<li>Update our sidebar to listen to, and display data from, the new store.</li>
</ul>
<p>In this guide, we&#39;ll fetch the GitHub profile for the currently focused contact and display a link to it, using the <a href="https://developer.github.com/v3/search/">GitHub API</a>.</p>
<h2 id="creating-the-store">Creating the Store</h2>
<p>The boilerplate to create a new store which listens to <code>FocusedContactsStore</code> looks like this:</p>
<p><div class="filename">lib/github-user-store.coffee</div></p>
<pre><code class="lang-coffee">Reflux = <span class="hljs-built_in">require</span> <span class="hljs-string">'reflux'</span>
{FocusedContactsStore} = <span class="hljs-built_in">require</span> <span class="hljs-string">'nylas-exports'</span>

<span class="hljs-built_in">module</span>.exports =

GithubUserStore = Reflux.createStore

  <span class="hljs-attribute">init</span>: <span class="hljs-function">-&gt;</span>
      <span class="hljs-property">@listenTo</span> FocusedContactsStore, <span class="hljs-property">@_onFocusedContactChanged</span>

  <span class="hljs-attribute">_onFocusedContactChanged</span>: <span class="hljs-function">-&gt;</span>
      <span class="hljs-comment"># TBD - This is fired when the focused contact changes</span>
      <span class="hljs-property">@trigger</span>(@)
</code></pre>
<p>(Note: You&#39;ll need to set up the <code>reflux</code> dependency.)</p>
<p>You should be able to drop this store into the sidebar example&#39;s <code>componentDidMount</code> method -- all it does is listen for the <code>FocusedContactsStore</code> to change, and then <code>trigger</code> its own event.</p>
<p>Let&#39;s build this out to retrieve some new data based on the focused contact, and expose it via a UI component.</p>
<h2 id="getting-data-in">Getting Data In</h2>
<p>We&#39;ll expand the <code>_onFocusedContactChanged</code> method to do something when the focused contact changes. In this case, we&#39;ll see if there&#39;s a GitHub profile for that user, and display some information if there is.</p>
<pre><code class="lang-coffee">request = <span class="hljs-built_in">require</span> <span class="hljs-string">'request'</span>

GithubUserStore = Reflux.createStore
  <span class="hljs-attribute">init</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@_profile</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@listenTo</span> FocusedContactsStore, <span class="hljs-property">@_onFocusedContactChanged</span>

  <span class="hljs-attribute">getProfile</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@_profile</span>

  <span class="hljs-attribute">_onFocusedContactChanged</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-comment"># Get the newly focused contact</span>
    contact = FocusedContactsStore.focusedContact()
    <span class="hljs-comment"># Clear the profile we're currently showing</span>
    <span class="hljs-property">@_profile</span> = <span class="hljs-literal">null</span>    
    <span class="hljs-keyword">if</span> contact
      <span class="hljs-property">@_fetchGithubProfile</span>(contact.email)
    <span class="hljs-property">@trigger</span>(@)

  <span class="hljs-attribute">_fetchGithubProfile</span>: <span class="hljs-function"><span class="hljs-params">(email)</span> -&gt;</span>
    <span class="hljs-property">@_makeRequest</span> <span class="hljs-string">"https://api.github.com/search/users?q=<span class="hljs-subst">#{email}</span>"</span>, <span class="hljs-function"><span class="hljs-params">(err, resp, data)</span> =&gt;</span>
      <span class="hljs-built_in">console</span>.warn(data.message) <span class="hljs-keyword">if</span> data.message?
      <span class="hljs-comment"># Make sure we actually got something back</span>
      github = data?.items?[<span class="hljs-number">0</span>] ? <span class="hljs-literal">false</span>
      <span class="hljs-keyword">if</span> github
        <span class="hljs-property">@_profile</span> = github
        <span class="hljs-built_in">console</span>.log(github)
    <span class="hljs-property">@trigger</span>(@)

  <span class="hljs-attribute">_makeRequest</span>: <span class="hljs-function"><span class="hljs-params">(url, callback)</span> -&gt;</span>
    <span class="hljs-comment"># GitHub needs a User-Agent header. Also, parse responses as JSON. </span>
    request({<span class="hljs-attribute">url</span>: url, <span class="hljs-attribute">headers</span>: {<span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'request'</span>}, <span class="hljs-attribute">json</span>: <span class="hljs-literal">true</span>}, callback)
</code></pre>
<p>The <code>console.log</code> line should show the GitHub profile for a contact (if they have one!) inside the Developer Tools Console, which you can enable at <code>Developer &gt; Toggle Developer Tools</code>.</p>
<p>You may run into rate-limiting issues with the GitHub API; to avoid these, you can add <a href="https://developer.github.com/v3/#authentication">authentication</a> with a <a href="https://github.com/settings/tokens">pre-baked token</a> by modifying the HTTP request your store makes. <strong>Caution! Use this for local development only.</strong> You could also try implementing a simple cache to avoid making the same request multiple times.</p>
<h2 id="display-time">Display Time</h2>
<p>To display this new data in the sidebar, we need to make sure our component is listening to the store, and load the appropriate state when it changes.</p>
<pre><code class="lang-coffee"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GithubSidebar</span> <span class="hljs-keyword"><span class="hljs-keyword">extends</span></span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span>
</span>  ...
  componentDidMount: =&gt;
    <span class="hljs-annotation">@unsubscribe</span> = <span class="hljs-type">GithubUserStore</span>.listen(@_onChange)

  _onChange: =&gt;
    <span class="hljs-annotation">@setState</span>(@_getStateFromStores())

  _getStateFromStores: =&gt;
    github: <span class="hljs-type">GithubUserStore</span>.getProfile()
</code></pre>
<p>Now we can access <code>@state.github</code> (which is the GitHub user profile object), and display the information it contains by updating the <code>render</code> and <code>renderContent</code> methods. </p>
<p>For example:</p>
<pre><code class="lang-coffee">  _renderContent: =&gt;
    <span class="hljs-tag">&lt;<span class="hljs-title">img</span> <span class="hljs-attribute">className</span>=<span class="hljs-value">"github"</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">{@state.github.avatar_url}</span>/&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">{@state.github.html_url}</span>&gt;</span>GitHub<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
</code></pre>
<h2 id="extending-the-store">Extending The Store</h2>
<p>To make this package more compelling, we can extend the store to make further API requests and fetch more data about the user. Passing this data back to the UI component follows exactly the same pattern as the barebones data shown above, so we&#39;ll leave it as an exercise for  the reader. :)</p>
<blockquote>
<p>You can find a more extensive version of this example in our <a href="https://github.com/nylas/edgehill-plugins/tree/master/sidebar-github-profile">sample packages repository</a>.</p>
</blockquote>

</div>

</div>

<div id="footer">
  <div class="container">
    <img src="images/edgehill.png" class="logo" />
    <div class="small">Nylas Mail Developer Preview<br><em>© 2014-2015 Nylas, Inc.</em></div>
  </div>
</div>

</body>
</html>
